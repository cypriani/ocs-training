<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cluster Wide Storage Management :: OCS Training</title>
    <link rel="canonical" href="https://red-hat-storage.github.io/ocs-training/training/ocs4/ocs4-cluster-storage-quotas.html">
    <meta name="generator" content="Antora 3.0.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGCEEZGN54"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-LGCEEZGN54')</script>
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Installation and Configuration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf.html">ODF General deploy and use</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-install-no-ui.html">OCS CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-install-no-ui.html">ODF CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-encryption.html">External KMS Encryption</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-enable-rgw.html">Use RGW in OCS deployment</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="ocs4-cluster-storage-quotas.html">Cluster wide storage management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Disaster recovery</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-multisite-ramen.html">ODF 4.9 Regional disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf410-multisite-ramen.html">ODF 4.10 Regional disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-metro-stretched.html">Stretch Cluster disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf410-metro-ramen.html">ODF 4.10 Metro disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf411-metro-ramen.html">ODF 4.11 Metro disaster recovery (WIP)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Development preview features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-dbwal.html">BlueStore RocksDB metadata and WAL placement</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-devtype.html">Mixed OSD device type configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-override.html">Ceph configuration override</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-segregation.html">Data Segregation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../infra-nodes/ocs4-infra-nodes.html">Deploying on Infra nodes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4perf/ocs4perf.html">Test deployment post-install</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Installation and Configuration</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OCS Installation and Configuration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../RegionalDR/index.html">ODF Regional DR</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../RegionalDR/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Installation and Configuration</a></li>
    <li><a href="ocs4-cluster-storage-quotas.html">Cluster wide storage management</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-training/edit/master/training/modules/ocs4/pages/ocs4-cluster-storage-quotas.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Cluster Wide Storage Management</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it comes to persistent storage in your OpenShift clusters, there is usually only so much of it to go around. As an OpenShift cluster admin, you want to ensure that in the age of self-service, your consumers do not take more storage than their fair share. More importantly you want to ensure that your users don&#8217;t oversubscribe and consume more storage than you have. This is especially true when the storage system you are using leverages "Thin Provisioning." How do you go about controlling this in OpenShift? Enter the <strong>ClusterResourceQuota</strong> and Project level <strong>ResourceQuotas</strong>.</p>
</div>
<div class="paragraph">
<p>A <strong>ClusterResourceQuota</strong> object allows quotas to be applied across multiple projects in OpenShift. <strong>ClusterResourceQuotas</strong> aggregate resources used in all projects selected by the quota and can limit resources across all the selected projects. To make this an effective solution for managing storage across your entire cluster all projects will need to have an annotation added which makes it a part of the <strong>ClusterResourceQuota</strong>. By utilizing a default Project template we can ensure that all Projects are created by default with this annotation.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong><em>NOTE</em>:</strong>
Selecting more than 100 projects under a single multi-project quota can have detrimental effects on API server responsiveness in those projects!</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>2. Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These requirements need to be met before proceeding:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An OCP 4.x cluster</p>
</li>
<li>
<p>At least one StorageClass defined</p>
</li>
<li>
<p>Administrator rights on the cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identifying_storage_classes"><a class="anchor" href="#_identifying_storage_classes"></a>3. Identifying Storage Classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To begin we are going to need to identify the types of storage available within your cluster. This can be done by running <code>oc get storageclass</code> command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get storageclass</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                          PROVISIONER                             RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
ocs-storagecluster-ceph-rbd   openshift-storage.rbd.csi.ceph.com      Delete          Immediate           true                   8m15s
ocs-storagecluster-ceph-rgw   openshift-storage.ceph.rook.io/bucket   Delete          Immediate           false                  8m15s
ocs-storagecluster-cephfs     openshift-storage.cephfs.csi.ceph.com   Delete          Immediate           true                   8m15s
openshift-storage.noobaa.io   openshift-storage.noobaa.io/obc         Delete          Immediate           false                  6d23h
thin (default)                kubernetes.io/vsphere-volume            Delete          Immediate           false                  27d</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in our example above, there are multiple storage classes available in this cluster including <em>ocs-storagecluster-cephfs</em>, <em>ocs-storagecluster-ceph-rbd</em> and <em>thin</em>. We will see how these different storage classes come into play with our ClusterResourceQuota later in this post.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong><em>Note</em></strong> The CSI driver that handles your storage provisioning must support quotas and quota enforcement for this to work properly. Check with your CSI provider to validate if storage quota is supported.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_clusterresourcequota"><a class="anchor" href="#_creating_a_clusterresourcequota"></a>4. Creating a ClusterResourceQuota</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To begin, We will create a <strong>ClusterResourceQuota</strong> to manage the maximum amount of storage that will be allocated for the cluster. In the example below, we have identified "40Gi" as the maximum amount of storage we want to be allocated across all <strong>Projects</strong> with the <em>"clusterstoragequota: enabled"</em> annotation. The <em>requests.storage</em> for your cluster will vary based on your specific storage constraints. Create a file called <code>clusterresourcequota-storage.yaml</code> and place the following data in it.</p>
</div>
<div class="listingblock">
<div class="title">clusterresourcequota-storage.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ClusterResourceQuota
metadata:
  name: totalclusterstorage
spec:
  quota:
    hard:
      requests.storage: "40Gi"
  selector:
    annotations:
      clusterstoragequota: enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, we are setting the quota to 40GB. This works well to illustrate how ClusterResourceQuotas will work on your cluster, but does not reflect a real-world scenario. When determining the value for your cluster-wide quota setting you should take into account the total amount of <em>usable</em> storage available to the cluster. For example:</p>
</div>
<div class="paragraph">
<p>If you have an ODF Cluster with 3x2TB volumes and it is replica=3 the effective storage is 2TB. Ceph is configured in ODF to have a hard limit at 85%. At the 85% mark, the cluster becomes read only. Because of this, we should ensure that the requests.storage is lower than 85%, say 75% of 2TB or 1.5TB. Setting the <strong>ClusterResourceQuota</strong> in this manner would ensure that your storage usage does not go above the 85% mark and switch to a read-only state. Be sure if you implement this control in your cluster that you choose the proper quota settings and to update the requests.storage field for your needs.</p>
</div>
<div class="paragraph">
<p>Apply the <strong>ClusterResourceQuota</strong> to your cluster by running the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc create -f clusterresourcequota-storage.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">clusterresourcequota.quota.openshift.io/totalclusterstorage created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_and_annotate_projects"><a class="anchor" href="#_create_and_annotate_projects"></a>5. Create and Annotate Projects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have now created a <strong>ClusterResourceQuota</strong>, but it does not have any projects to select, and include as part of the quota. We will create two new projects and manually add a annotation to these projects for our testing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ oc new-project myproject
Now using project "myproject" on server "https://api.ocp47.example.com:6443".
$ oc new-project myproject2
Now using project "myproject2" on server "https://api.ocp47.example.com:6443".
$ oc annotate namespace myproject clusterstoragequota=enabled
namespace/myproject annotated
$ oc annotate namespace myproject2 clusterstoragequota=enabled
namespace/myproject2 annotated</code></pre>
</div>
</div>
<div class="paragraph">
<p>By adding the annotation <em>clusterstoragequota=enabled</em> to both projects, they are now subject to the control of the <strong>ClusterResourceQuota</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_namespace_quota"><a class="anchor" href="#_create_a_namespace_quota"></a>6. Create a Namespace quota</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The creation of a <strong>ClusterResourceQuota</strong> allows us to control the overall use of storage in the cluster, but it does not keep one <strong>Project</strong> from consuming all that storage. To control storage at a <strong>Project</strong> level, we will create a <strong>ResourceQuota</strong>. <strong>ResourceQuota</strong>s are Kubernetes constructs that can be used to limit the amount of resources that can be consumed within a given <strong>Project</strong>. Leveraging the test projects we created in the last step, we will create a separate quota for each test project. Create two project quotas, one on <em>myproject</em> and a different quota on <em>myproject2</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ oc create quota myprojectstoragequota --hard=requests.storage=30Gi -n myproject
resourcequota/myprojectstoragequota created
$ oc create quota myproject2storagequota --hard=requests.storage=25Gi -n myproject2
resourcequota/myproject2storagequota created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_checking_quotas"><a class="anchor" href="#_checking_quotas"></a>7. Checking quotas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have applied our <strong>ClusterResourceQuota</strong> as well as a quota to individual <strong>Projects</strong>, lets take a look at how these quotas are reflected in your cluster. Using the oc command ensure you are on the "myproject" project we created earlier.</p>
</div>
<div class="paragraph">
<p>Now, review the <strong>ClusterResourceQuota</strong> that is assigned by describing the <strong>AppliedResourceQuota</strong>:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project myproject
$ oc describe AppliedClusterResourceQuota</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:		totalclusterstorage
Created:	2 days ago
Labels:		&lt;none&gt;
Annotations:	&lt;none&gt;
Namespace Selector: ["myproject" "myproject2"]
Label Selector:
AnnotationSelector: clusterstoragequota=enabled
Resource            Used	Hard
--------            ----	----
requests.storage    0Gi	40Gi</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note</strong> all the projects that are summed up in the <strong>ClusterResourceQuota</strong> are displayed.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We can also look at the quota that has been applied at the <strong>Project</strong> level. To check the project quota run:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc describe quota -n myproject</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:             storage-consumption
Namespace:        myproject
Resource          Used  Hard
--------          ----  ----
requests.storage  0Gi   30Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have validated that both the <strong>ClusterResourceQuota</strong> and the <strong>ResourceQuota</strong> is applied to our cluster. We will now see how they affect storage creation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_the_quotas"><a class="anchor" href="#_exercise_the_quotas"></a>8. Exercise the quotas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With our storage quotas in place at both the cluster level and the project level, we will test them out to see how they work together to ensure that they are controlling storage use. Start by creating a <strong>PersistentVolumeClaim</strong> (PVC) that is less than the quota applied at the project level. Create a file called <code>storageclaim1.yaml</code> with the following contents ensuring that you update &lt;storageClassName&gt; with a storage class present in your cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: storageclaim1
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: &lt;storageClassName&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the <strong>PVC</strong> in your project <code>oc create -f storageclaim1.yaml</code>. Now see how the <strong>PVC</strong> you just created is reflected in both your <strong>Project</strong> and cluster quotas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ oc create -f storageclaim1.yaml -n myproject
persistentvolumeclaim/storageclaim1 created
$ oc describe AppliedClusterResourceQuota
Name:		totalclusterstorage
Created:	2 days ago
Labels:		&lt;none&gt;
Annotations:	&lt;none&gt;
Namespace Selector: ["myproject" "myproject2"]
Label Selector:
AnnotationSelector: clusterstoragequota=enabled
Resource            Used	Hard
--------            ----	----
requests.storage    5Gi	40Gi
$ oc describe quota -n myproject
Name:             storage-consumption
Namespace:        myproject
Resource          Used  Hard
--------          ----  ----
requests.storage  5Gi   30Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above output we can see that the <strong>ClusterResourceQuota</strong> is showing that 5Gi has been allocated across the entire cluster. We can also see that for the project, 5Gi has been allocated from the project level quota. This leaves 25Gi of available storage to be allocated at the project level, and 35Gi available to be allocated for the over all cluster.</p>
</div>
<div class="paragraph">
<p>Create a second <strong>PVC</strong> file called <em>storageclaim2.yaml</em>, and change the storage request to 20Gi. We will apply this to our second <strong>Project</strong> <em>myproject2</em> and then see how the <strong>ClusterResourceQuota</strong> reflects this change.</p>
</div>
<div class="listingblock">
<div class="title">storageclaim2.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ oc create -f storageclaim2.yaml -n myproject2
persistentvolumeclaim/storageclaim2 created
$ oc describe AppliedClusterResourceQuota
Name:		totalclusterstorage
Created:	2 days ago
Labels:		&lt;none&gt;
Annotations:	&lt;none&gt;
Namespace Selector: ["myproject" "myproject2"]
Label Selector:
AnnotationSelector: clusterstoragequota=enabled
Resource            Used	Hard
--------            ----	----
requests.storage    25Gi	40Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the used storage for the cluster has increased by 20Gi. To validate that the <strong>ClusterResourceQuota</strong> is enforcing our quota across multiple projects, create one more pvc file called <em>storageclaim3.yaml</em> and change the storage request to 20Gi. We will apply this storage claim to the <em>myproject</em> project which is currently using 5Gi of its 30Gi quota, thus within the project level quota we have remaining. It will however exceed the maximum amount of cluster storage we want to allocate.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc create -f storageclaim3.yaml -n myproject</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">persistentvolumeclaim/storageclaim3 created
Error from server (Forbidden): error when creating "storageclaim3.yaml": persistentvolumeclaims "storageclaimclaim3" is forbidden: exceeded quota: totalclusterstorage, requested: requests.storage=20Gi, used: requests.storage=25Gi, limited: requests.storage=40Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Success! We have ensured that the total storage allocated across multiple projects does not exceed our <strong>ClusterResourceRequest</strong> limit. The only issue at this point, is that we need to add an annotation to each new project as it is created. This is where <strong>Project Templates</strong> come in to help us manage this step automatically.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_project_template_that_includes_storage_annotation"><a class="anchor" href="#_creating_a_project_template_that_includes_storage_annotation"></a>9. Creating a Project Template that includes storage annotation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have seen how you can manually apply annotations to projects, and how those annotations affect our <strong>ClusterResourceQuota</strong>, we will make sure that all future projects that are created include the annotation that adds it to our <strong>ClusterResourceQuota</strong>.</p>
</div>
<div class="paragraph">
<p>We will start be creating a default project template:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc adm create-bootstrap-project-template -o yaml &gt; template.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the template.yaml file we just created updating the name of the template, and adding our "clusterstoragequota: enabled" annotation to the section <em>objects.metadata.annotations</em>:</p>
</div>
<div class="listingblock">
<div class="title">template.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: template.openshift.io/v1
kind: Template
metadata:
  creationTimestamp: null
  name: &lt;template_name&gt;
objects:
- apiVersion: project.openshift.io/v1
  kind: Project
  metadata:
    annotations:
      clusterstoragequota: enabled
      openshift.io/description: ${PROJECT_DESCRIPTION}
      openshift.io/display-name: ${PROJECT_DISPLAYNAME}
      openshift.io/requester: ${PROJECT_REQUESTING_USER}
    creationTimestamp: null
    name: ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now apply the newly created template to your cluster:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc create -f template.yaml -n openshift-config</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">template.template.openshift.io/&lt;template_name&gt; created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, edit the cluster config to start using the new template.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit project.config.openshift.io/cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the "spec" section add the following, ensuring to update <em>&lt;template_name&gt;</em> with the name you selected when you created your template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
 projectRequestTemplate:
    name: &lt;template_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate that the project template properly applies our annotation, create a new project <em>myproject3</em> and validate that it is a part of the <strong>ClusterResourceQuota</strong>:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc new-project myproject3
$ oc describe AppliedClusterResourceQuota</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:		totalclusterstorage
Created:	2 days ago
Labels:		&lt;none&gt;
Annotations:	&lt;none&gt;
Namespace Selector: ["myproject" "myproject2" "myproject3"]
Label Selector:
AnnotationSelector: clusterstoragequota=enabled
Resource            Used	Hard
--------            ----	----
requests.storage    25Gi	40Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the newly created <em>myproject3</em> is automatically added to the <strong>ClusterResourceQuota</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cluster_quotas_with_multiple_storage_classes"><a class="anchor" href="#_cluster_quotas_with_multiple_storage_classes"></a>10. Cluster Quotas with Multiple Storage Classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <strong>ClusterResourceQuota</strong> and project quotas that we have created thus far aggregate all cluster storage classes together. What if you want to set quotas on a per-class basis? This can be done by calling out the specific storage classes that you want to set the quotas on. Let&#8217;s start with the <strong>ClusterResourceQuota</strong> we have been using thus far and add some additional targeted classes by adding individual lines to the hard quota in the form <em>&lt;storageClassName&gt;.storageclass.storage.k8s.io/requests.storage: &lt;value&gt;</em>. Use the <code>oc edit ClusterResourceQuota/totalclusterstorage</code> command to edit the quota directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ClusterResourceQuota
metadata:
  name: totalclusterstorage
spec:
  quota:
    hard:
      thin.storageclass.storage.k8s.io/requests.storage: "40Gi"
      ocs-storagecluster-cephfs.storageclass.storage.k8s.io/requests.storage: "80Gi"
      ocs-storagecluster-ceph-rbd.storageclass.storage.k8s.io/requests.storage: "0Gi"
  selector:
    annotations:
      clusterstoragequota: enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>The YAML above creates a cluster level quota for storage that does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensures no more than 40Gi of storage can be assigned in your cluster from the "thin" storage class</p>
</li>
<li>
<p>Ensures no more than 80Gi of storage can be assigned in your cluster from the "ocs-storagecluster-cephfs" class</p>
</li>
<li>
<p>Does not allow provisioning of any "ocs-storagecluster-ceph-rbd" storage class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Validate this by getting the <strong>AppliedClusterResourceQuota</strong>:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc describe AppliedClusterResourceQuota</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:		totalclusterstorage
Created:	21 seconds ago
Labels:		&lt;none&gt;
Annotations:	&lt;none&gt;
Namespace Selector: ["myproject" "myproject3" "myproject2"]
Label Selector:
AnnotationSelector: clusterstoragequota=enabled
Resource						                                  Used	Hard
--------						                                  ----	----
managed-nfs-storage.storage.k8s.io/requests.storage	  0	    80Gi
requests.storage					                            14Gi	100Gi
thin.storageclass.storage.k8s.io/requests.storage	    10Gi	40Gi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Feel free to jump back to the <a href="#exercise-the-quotas">Exercise the quotas</a> section and target the additional storage classes you created to see how they work.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>11. Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By combining OpenShift <strong>Project Templates</strong>, and <strong>ClusterResouceQuotas</strong> along with project quotas OpenShift cluster administrators can take back control and manage storage allocated within their cluster. Remember that you will need to retrofit all existing projects that use <strong>PVCs</strong> to have the annotation on the project following the steps in the <a href="#create-and-annotate-projects">Create and Annotate Projects</a> section of this document. Use caution when applying annotations to existing projects to ensure that you do not adversely effect applications deployed in these projects. The concepts that are shown here apply to any object type that can have a quota applied.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
